var BF_UniversalDOM=function(){this.UNIVERSAL_DOM_CLASS="bf_dom";this.UNIVERSAL_DOM_ATTR="rel:bf_bucket";this.UNIVERSAL_DOM_DATA_ATTR="rel:bf_bucket_data";this.UNIVERSAL_DOM_BUCKET_DATA_ATTR="rel:bf_data";this._bucket={};this._element_assignment_lookup={};this.init=function(){universal_dom._bucket={};$$("."+universal_dom.UNIVERSAL_DOM_CLASS).each(function(el){universal_dom._assign(el)})};this.get_bucket_elements=function(bucket){if(typeof universal_dom._bucket[bucket]=="undefined"){return[]}var elements=[];universal_dom._bucket[bucket].elements.each(function(obj){elements.push(obj.element)});return elements};this.get_bucket_elements_with_data=function(bucket,data){if(typeof universal_dom._bucket[bucket]=="undefined"){return[]}var elements=[];universal_dom._bucket[bucket].elements.each(function(el){var matches=true;for(var each in data){if(typeof el.data[each]=="undefined"||el.data[each]!=data[each]){matches=false}}if(matches){elements.push(el.element)}});return elements};this.class_regex=new RegExp(this.UNIVERSAL_DOM_CLASS);this.update=function(snippet){var s=$(snippet);if(s){var elements=s.select('[class~="'+universal_dom.UNIVERSAL_DOM_CLASS+'"]');if(elements.length==0&&s.innerHTML.match(universal_dom.class_regex)){elements=new Array();universal_dom.extract_dom_class_elements(snippet,elements)}if(s.hasClassName(this.UNIVERSAL_DOM_CLASS)){elements.push(s)}elements.each(function(el){universal_dom._assign(el)})}};this.extract_dom_class_elements=function(snippet,list){if(snippet.className&&snippet.className.match(universal_dom.class_regex)){list.push(snippet)}for(var i=0;i<snippet.childNodes.length;i++){universal_dom.extract_dom_class_elements(snippet.childNodes[i],list)}};this.assign_handler=function(obj){var bucket=obj.bucket;var handler=obj.handler;var event=obj.event||"immediate";var needs_to_be_added=true;var my_bucket=universal_dom._bucket[bucket]||{};var handlers=my_bucket.handlers||{};var handler_list=handlers[event]||[];handler_list.each(function(fn){if(fn==handler){needs_to_be_added=false}});if(needs_to_be_added){handler_list.push(handler);handlers[event]=handler_list;my_bucket.handlers=handlers;universal_dom._bucket[bucket]=my_bucket}universal_dom._assign_handler(bucket)};this.add_element_to_bucket=function(obj){var bucket=obj.bucket;var element=obj.element;var data=obj.data;var the_bucket=universal_dom._bucket[bucket]||{};var bucket_elements=the_bucket.elements||[];bucket_elements.push({element:element,data:data});the_bucket.elements=bucket_elements;universal_dom._bucket[bucket]=the_bucket;universal_dom._assign_handler(bucket);var assigned_to_buckets=universal_dom._element_assignment_lookup[element]||[];assigned_to_buckets.push(bucket);universal_dom._element_assignment_lookup[element]=assigned_to_buckets};this.remove_element_from_buckets=function(element){var buckets=universal_dom._element_assignment_lookup[element];if(buckets){buckets.each(function(bucket){var new_bucket_elements=[];universal_dom._bucket[bucket].elements.each(function(el){if(el.element!=element){new_bucket_elements.push(el)}});universal_dom._bucket[bucket].elements=new_bucket_elements})}};this.refresh_immediate_bucket=function(bucket){if(universal_dom._bucket[bucket].elements){universal_dom._bucket[bucket].elements.each(function(obj){if(universal_dom._bucket[bucket].handlers.immediate){universal_dom._bucket[bucket].handlers.immediate.each(function(fn){fn(obj.element,obj.data)})}})}};this._assign_handler=function(for_bucket){var bucket=universal_dom._bucket[for_bucket];var handlers=bucket.handlers;if(typeof bucket.elements=="undefined"){bucket.elements=[]}for(var i=0;i<bucket.elements.length;i++){var element=bucket.elements[i].element;var data=bucket.elements[i].data;data.element=element;for(var event in handlers){handlers[event].each(function(fn){var assigned=data.assigned||{};if(typeof assigned[fn.toString()]=="undefined"){if(event=="immediate"){fn(element,data)}else{var cl=Object.clone(data);element.observe(event,function(e){for(var each in cl){e[each]=cl[each]}fn(e)})}}assigned[fn.toString()]=true;data.assigned=assigned;universal_dom._bucket[for_bucket].elements[i].data=data})}}};this._assign=function(el){if(el.hasAttribute(this.UNIVERSAL_DOM_ATTR)){this.bucket_attr(el)}else{if(el.hasAttribute(this.UNIVERSAL_DOM_DATA_ATTR)){this.bucket_data_attr(el)}else{}}};this.update_or_add_element_in_bucket=function(obj){var bucket=obj.bucket;var element=obj.element;var data=obj.data;var b=universal_dom._bucket[bucket];if(typeof b=="undefined"||typeof b.elements=="undefined"||b.elements.length==0){universal_dom.add_element_to_bucket({bucket:bucket,element:element,data:data});return}var exists=0;b.elements.each(function(b_element,index){if(b_element.element==element){b.elements[index].data=data;exists=1;throw $break}});if(!exists){universal_dom.add_element_to_bucket({bucket:bucket,element:element,data:data})}};this.bucket_attr=function(el){var bucket="";try{bucket=el.getAttribute(universal_dom.UNIVERSAL_DOM_ATTR);var data={};var data_attr=el.getAttribute(universal_dom.UNIVERSAL_DOM_BUCKET_DATA_ATTR);if(data_attr){data=eval("("+data_attr+")")}var buckets=bucket.split(" ");buckets.each(function(bucket_name){universal_dom.update_or_add_element_in_bucket({element:el,bucket:bucket_name,data:data})})}catch(e){console.error(e+bucket+el.id+universal_dom.UNIVERSAL_DOM_BUCKET_DATA_ATTR)}};this.bucket_data_attr=function(el){var data=el.getAttribute(universal_dom.UNIVERSAL_DOM_DATA_ATTR);try{var obj=eval("("+data+")")}catch(e){console.error("Failed to parse JSON ("+data+") for element "+el+" (id:"+el.id+",class:"+el.className+",tag:"+el.tagName+")")}for(var bucket_name in obj){universal_dom.update_or_add_element_in_bucket({element:el,bucket:bucket_name,data:obj[bucket_name]})}};this.remove_bucket_elements=function(array_of_buckets){array_of_buckets.each(function(bucket){if(typeof universal_dom._bucket[bucket]!="undefined"){delete universal_dom._bucket[bucket].elements}})};this.assign_ids_to_elements_in_bucket=function(bucket,callback){universal_dom._bucket[bucket].elements.each(function(el,idx){if(typeof el.element!="undefined"&&!el.element.id){el.element.id=callback(idx)}})}};var universal_dom=new BF_UniversalDOM();universal_dom.init();universal_dom.assign_handler({bucket:"toggle",event:"click",handler:function(b){b.stop();var a=function(c){if(c.style.display=="none"){c.toggle()}else{if(c.hasClassName("hidden")){c.removeClassName("hidden")}else{c.addClassName("hidden")}}};if(typeof b.el!="undefined"){a($(b.el))}if(typeof b.els!="undefined"){b.els.each(function(c){a($(c))})}}});universal_dom.assign_handler({bucket:"stop",event:"click",handler:Event.stop});BF_ProgLoad_Images=function(){this.images=new Hash();this.index=1;this.DEBUG=false;this.bad_browser=0;this.autoload=false;this.autoload_interval=1000;this.min_lookahead_pixels=400;this.init_total_delay=0;this.init_max_delay=10000;this.init_delay_interval=250;var a=this;this.init=function(){bf_prog_load.media=new Hash();if(document.location.search.match(/progload_debug=true/)){this.DEBUG=true;console.debug("init progressive image loader...")}try{this.lookahead_pixels=document.viewport.getHeight();if(window.BF_IS_TOP_LIST&&this.lookahead_pixels<2000){this.lookahead_pixels=2000}if(this.lookahead_pixels<a.min_lookahead_pixels&&a.init_total_delay<a.init_max_delay){a.init_total_delay+=a.init_delay_interval;setTimeout(bf_prog_load.init,a.init_delay_interval);return}var c=document.viewport.getScrollOffsets();var b=c[1];b=document.viewport.getHeight()+b;universal_dom.get_bucket_elements("progload").each(function(g){var f=g.getAttribute("rel:bf_image_src");var e=g.cumulativeOffset()[1];if(bf_prog_load.DEBUG){console.log("INIT viewport: %s image offset: %s image: %s lookahead: %s pixels",b,e,f,bf_prog_load.lookahead_pixels);g.title=e}if(b>(e-bf_prog_load.lookahead_pixels)){if(bf_prog_load.DEBUG){g.style.border="solid red 1px"}a.load_image(g,((f.indexOf("http://")==0)?f:BF_STATIC.image_root+f))}else{var h={el:g,position:e,src:f};bf_prog_load.media.set(""+bf_prog_load.index,h);bf_prog_load.index++}});universal_dom.get_bucket_elements("progload_video").each(function(g){var f=g.cumulativeOffset()[1];bf_prog_load.media.set(""+bf_prog_load.index,{data:g,position:f,type:"video"});bf_prog_load.index++});if((Prototype.Browser.IE&&parseInt(navigator.userAgent.substring(navigator.userAgent.indexOf("MSIE")+5))==6)||Prototype.Browser.Opera||!!window.fb_app){bf_prog_load.bad_browser=1;setTimeout(function(){bf_prog_load.scrolled("all")},500)}else{Event.observe(window,"scroll",function(f){bf_prog_load.scrolled()})}}catch(d){console.error(d)}universal_dom.assign_handler({bucket:"add_to_prog_load",handler:bf_prog_load.add});a.autoload_images()};this.autoload_images=function(){a.autoload=true;if(a.DEBUG){console.info("Starting image autoload")}var b;b=setInterval(function(){if(!bf_prog_load.media.size()){if(a.DEBUG){console.info("End image autoload")}a.autoload=false;clearInterval(b)}else{bf_prog_load.media.each(function(d){if(!d.value.type){var c=d.value.el.getAttribute("rel:bf_image_src");if(c==d.value.el.src){return}if(a.DEBUG){d.value.el.style.border="solid orange 1px"}a.load_image(d.value.el,((d.value.src.indexOf("http://")==0)?d.value.src:BF_STATIC.image_root+d.value.src));bf_prog_load.media.unset(d.key);throw $break}})}},a.autoload_interval)};this.image_watcher=function(c,e,d,b){this.maxRetries=3;this.retry=0;this.retryTimeout=[10000,20000,30000];this.el=c;this.src=e;this.success=d;this.error=b;this.load=function(){if(a.DEBUG){console.log((this.retry==0?"First":("Try #"+this.retry))+" load "+this.src)}this.image=new Image();this.image.onload=function(f){return function(){f.onsuccess.call(f)}}(this);this.image.onabort=function(f){return function(){f.timeout.call(f)}}(this);this.image.onerror=function(f){return function(){f.timeout.call(f)}}(this);this.image.src=this.src};this.onsuccess=function(){this.image=null;this.success(this)};this.timeout=function(){this.image=null;if(this.retry>=this.maxRetries){this.error(this);return}if(a.DEBUG){console.log("Waiting "+this.retryTimeout[this.retry]+" ms on "+this.src)}setTimeout(function(f){return function(){f.load.call(f)}}(this),this.retryTimeout[this.retry]);this.retry++}};this.load_image=function(b,c){new this.image_watcher(b,c,function(d){if(a.DEBUG){console.info("Image %s was loaded successfully.",d.src)}b.src=c},function(d){if(a.DEBUG){console.error("Image %s wasn't loaded.",d.src)}b.src=BF_STATIC.image_root+"/static/images/public/backgrounds/trans.gif"}).load()};this.scrolled=function(b){try{bf_prog_load.media.each(function(f){var e=document.viewport.getScrollOffsets();var d=e[1];d=document.viewport.getHeight()+d;if(d>(f.value.position-bf_prog_load.lookahead_pixels)||b){if(bf_prog_load.DEBUG){console.log("SCROLL viewport: %s image offset: %s image: %s",d,f.value.position,f.value.src);if(b){f.value.el.style.border="solid green 1px"}else{f.value.el.style.border="solid blue 1px"}}if(f.value.data){embed_video.load_video(f.value.data,true)}else{a.load_image(f.value.el,((f.value.src.indexOf("http://")==0)?f.value.src:BF_STATIC.image_root+f.value.src))}bf_prog_load.media.unset(f.key)}})}catch(c){console.error(c)}};this.add=function(f){var d=f.getAttribute("rel:bf_image_src");var b=f.cumulativeOffset()[1];var g=document.viewport.getScrollOffsets();var c=g[1];c=document.viewport.getHeight()+c;if(c>(b-bf_prog_load.lookahead_pixels)||bf_prog_load.bad_browser){if(bf_prog_load.DEBUG){f.style.border="solid yellow 1px";console.log("SHOW (add). offset: %s image: %s lookahead: %s pixels",b,d,bf_prog_load.lookahead_pixels)}a.load_image(f,((d.indexOf("http://")==0)?d:BF_STATIC.image_root+d))}else{var i={el:f,position:b,src:d};if(bf_prog_load.DEBUG){console.log("ADDING image. offset: %s image: %s lookahead: %s pixels",b,d,bf_prog_load.lookahead_pixels)}bf_prog_load.media.set(""+bf_prog_load.index,i);bf_prog_load.index++;if(!a.autoload){a.autoload_images()}}var e=f.getAttribute("rel:bf_bucket");var h=e.replace("add_to_prog_load","xx");f.setAttribute("rel:bf_bucket",h)}};var bf_prog_load=new BF_ProgLoad_Images();BuzzLoader.register(function(){bf_prog_load.init()},2);